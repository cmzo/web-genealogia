<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årbol Geneal√≥gico - Vis.js</title>
    <link rel="stylesheet" href="./assets/css/styles.css">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        .tree-container {
            width: 100%;
            height: 85vh;
            background: #f8fafc;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #374151;
            z-index: 1000;
            border: 1px solid #e5e7eb;
        }
        
        .key-hint {
            margin: 4px 0;
            font-weight: 500;
        }
        
        .focus-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 14px;
            color: #374151;
            max-width: 300px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
        }
        
        .focus-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .focus-details {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }
        
        .view-toggle {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
        }
        
        .view-toggle:hover {
            background: #f3f4f6;
        }
        
        .view-toggle.active {
            background: #3b82f6;
            color: white;
        }
        
        .stats-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #374151;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            min-width: 120px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-weight: 500;
        }
        
        .stat-value {
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="./index.html">‚Üê Inicio</a>
            <a href="./arbol.html">L√≠nea Directa</a>
        </nav>
    </header>

    <main>
        <section class="hero">
            <div class="hero-content">
                <h1>√Årbol Geneal√≥gico</h1>
                <p>Explora tu historia familiar con Vis.js</p>
            </div>
        </section>

        <section class="content">
            <div class="tree-container" id="tree">
                <div class="view-toggle" id="viewToggle">Vista: Completa</div>
                <div class="stats-panel" id="statsPanel">
                    <div class="stat-item">
                        <span>Personas:</span>
                        <span class="stat-value" id="personCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Generaciones:</span>
                        <span class="stat-value" id="generationCount">0</span>
                    </div>
                </div>
                <div class="controls">
                    <div class="key-hint">üñ±Ô∏è Arrastrar para mover</div>
                    <div class="key-hint">üîç Rueda para zoom</div>
                    <div class="key-hint">üéØ Clic para seleccionar</div>
                    <div class="key-hint">‚å®Ô∏è Flechas para navegar</div>
                </div>
                <div class="focus-info" id="focusInfo">
                    <div class="focus-name">Selecciona una persona</div>
                    <div class="focus-details">Haz clic en cualquier nodo para ver detalles</div>
                </div>
            </div>
        </section>
    </main>

    <footer style="background: #1f2937; color: white; text-align: center; padding: 20px; margin-top: 48px;">
        <div class="footer-container" style="max-width: 1200px; margin: 0 auto;">
            <p class="footer-text" style="margin: 0; font-size: 14px;">Matias Clemenzo 2025</p>
        </div>
    </footer>

    <script src="./assets/js/path-config.js"></script>
    <script src="./content/data/arbol.js"></script>
    <script>
        // Configuraci√≥n
        const SHEET_ID = '1sFJMyqqEBkDPuGaX3kXANqppTfWijo__kGjRYY8hDEI';
        const SHEET_GID = '0';
        
        // Estado del √°rbol
        let network = null;
        let currentFocus = null;
        let isDirectLineView = false;
        
        // Colores por generaci√≥n
        const generationColors = [
            '#3b82f6', // Azul - Generaci√≥n 0
            '#10b981', // Verde - Generaci√≥n 1
            '#f59e0b', // Naranja - Generaci√≥n 2
            '#ef4444', // Rojo - Generaci√≥n 3
            '#8b5cf6', // P√∫rpura - Generaci√≥n 4
            '#ec4899', // Rosa - Generaci√≥n 5
            '#06b6d4', // Cian - Generaci√≥n 6+
            '#84cc16'  // Lima - Generaci√≥n 7+
        ];
        
        // Funci√≥n para obtener datos de Google Sheets
        async function fetchGoogleSheet(sheetId, gid) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
            try {
                const response = await fetch(url);
                const text = await response.text();
                const jsonText = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonText);
                
                if (data.table && data.table.rows) {
                    return data.table.rows.map(row => {
                        const obj = {};
                        data.table.cols.forEach((col, index) => {
                            if (row.c[index]) {
                                obj[col.label] = row.c[index].v;
                            }
                        });
                        return obj;
                    });
                }
                return null;
            } catch (error) {
                console.warn('[Sheet] Error:', error);
                return null;
            }
        }
        
        // Funci√≥n para convertir datos a formato Vis.js
        function convertToVisData(rows) {
            const nodes = [];
            const edges = [];
            
            // Crear nodos
            rows.forEach(row => {
                const generation = parseInt(row.generation) || 0;
                const color = generationColors[generation % generationColors.length];
                
                const node = {
                    id: row.id,
                    label: row.name || 'Sin nombre',
                    title: `${row.name || 'Sin nombre'}\nGeneraci√≥n: ${generation}`,
                    color: {
                        background: color,
                        border: '#1f2937',
                        highlight: {
                            background: '#fbbf24',
                            border: '#f59e0b'
                        }
                    },
                    size: row.is_direct_line === 'true' || row.is_direct_line === '1' ? 25 : 20,
                    font: {
                        size: 12,
                        color: '#ffffff',
                        face: 'Inter, sans-serif'
                    },
                    borderWidth: row.is_direct_line === 'true' || row.is_direct_line === '1' ? 3 : 2,
                    generation: generation,
                    isDirectLine: row.is_direct_line === 'true' || row.is_direct_line === '1',
                    birthDate: row.birth_date || '',
                    deathDate: row.death_date || '',
                    birthPlace: row.birth_place || '',
                    spouseId: row.spouse_id || null
                };
                nodes.push(node);
            });
            
            // Crear enlaces padre-hijo
            rows.forEach(row => {
                if (row.parent_id && row.parent_id !== '') {
                    edges.push({
                        from: row.parent_id,
                        to: row.id,
                        arrows: 'to',
                        color: '#374151',
                        width: 2,
                        smooth: {
                            type: 'cubicBezier',
                            forceDirection: 'vertical'
                        }
                    });
                }
            });
            
            // Crear enlaces c√≥nyuges
            rows.forEach(row => {
                if (row.spouse_id && row.spouse_id !== '') {
                    const existingEdge = edges.find(edge => 
                        (edge.from === row.id && edge.to === row.spouse_id) ||
                        (edge.from === row.spouse_id && edge.to === row.id)
                    );
                    
                    if (!existingEdge) {
                        edges.push({
                            from: row.id,
                            to: row.spouse_id,
                            color: '#f59e0b',
                            width: 1,
                            dashes: true,
                            smooth: {
                                type: 'cubicBezier'
                            }
                        });
                    }
                }
            });
            
            return { nodes, edges };
        }
        
        // Funci√≥n para cargar datos locales
        function loadLocalData() {
            const exampleData = [
                { id: '1', parent_id: '', name: 'Juan Martin Clemenzo', birth_date: '2020', generation: '0', is_direct_line: 'true' },
                { id: '2', parent_id: '1', name: 'Matias Damian Clemenzo', birth_date: '1990', generation: '1', is_direct_line: 'true' },
                { id: '3', parent_id: '2', name: 'Daniel Jorge Clemenzo', birth_date: '1960', generation: '2', is_direct_line: 'true' },
                { id: '4', parent_id: '3', name: 'Felix Ricardo Clemenzo', birth_date: '1926', generation: '3', is_direct_line: 'true' },
                { id: '5', parent_id: '4', name: 'Felix Clemenzo', birth_date: '1894', generation: '4', is_direct_line: 'true' },
                { id: '6', parent_id: '5', name: 'Francisco Clemenzo', birth_date: '1856', generation: '5', is_direct_line: 'true' },
                { id: '7', parent_id: '2', name: 'Maria Cecilia Vargas', birth_date: '1965', generation: '2', is_direct_line: 'false' },
                { id: '8', parent_id: '4', name: 'Isabel Maria Queipo', birth_date: '1905', generation: '4', is_direct_line: 'false' },
                { id: '9', parent_id: '6', name: 'Celestina Roch', birth_date: '1887', generation: '5', is_direct_line: 'false' }
            ];
            
            return exampleData;
        }
        
        // Funci√≥n para crear el √°rbol con Vis.js
        function createTree(data) {
            const container = document.getElementById('tree');
            
            // Configuraci√≥n de Vis.js
            const options = {
                layout: {
                    hierarchical: {
                        direction: 'UD',
                        sortMethod: 'directed',
                        nodeSpacing: 150,
                        levelSeparation: 200,
                        treeSpacing: 200
                    }
                },
                physics: {
                    enabled: false
                },
                interaction: {
                    hover: true,
                    navigationButtons: true,
                    keyboard: {
                        enabled: true,
                        speed: {
                            x: 10,
                            y: 10,
                            zoom: 0.1
                        }
                    }
                },
                edges: {
                    smooth: {
                        type: 'cubicBezier',
                        forceDirection: 'vertical'
                    }
                },
                nodes: {
                    shape: 'circle',
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.2)',
                        size: 10,
                        x: 5,
                        y: 5
                    }
                }
            };
            
            // Crear red
            network = new vis.Network(container, data, options);
            
            // Eventos
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = data.nodes.find(n => n.id === nodeId);
                    if (node) {
                        setFocus(node);
                    }
                } else {
                    clearFocus();
                }
            });
            
            network.on('stabilizationIterationsDone', function() {
                updateStats();
            });
            
            // Configurar navegaci√≥n por teclado
            setupKeyboardNavigation();
        }
        
        // Funci√≥n para establecer foco
        function setFocus(node) {
            currentFocus = node;
            
            // Seleccionar nodo
            network.selectNodes([node.id]);
            
            // Actualizar informaci√≥n
            updateFocusInfo(node);
            
            // Centrar en el nodo
            network.focus(node.id, {
                scale: 1.2,
                animation: {
                    duration: 800,
                    easingFunction: 'easeInOutQuad'
                }
            });
        }
        
        // Funci√≥n para limpiar foco
        function clearFocus() {
            currentFocus = null;
            network.unselectAll();
            updateFocusInfo(null);
        }
        
        // Funci√≥n para actualizar informaci√≥n de foco
        function updateFocusInfo(node) {
            const focusInfo = document.getElementById('focusInfo');
            
            if (!node) {
                focusInfo.innerHTML = `
                    <div class="focus-name">Selecciona una persona</div>
                    <div class="focus-details">Haz clic en cualquier nodo para ver detalles</div>
                `;
                return;
            }
            
            const name = node.label;
            const birthDate = node.birthDate || '';
            const deathDate = node.deathDate || '';
            const birthPlace = node.birthPlace || '';
            const generation = node.generation || 0;
            const isDirect = node.isDirectLine;
            
            let details = '';
            if (birthDate) {
                details += `Nacimiento: ${birthDate}`;
                if (deathDate) details += ` - Fallecimiento: ${deathDate}`;
                details += '<br>';
            }
            
            if (birthPlace) {
                details += `Lugar: ${birthPlace}<br>`;
            }
            
            details += `Generaci√≥n: ${generation}`;
            
            if (isDirect) {
                details += ' ‚Ä¢ L√≠nea Directa';
            }
            
            focusInfo.innerHTML = `
                <div class="focus-name">${name}</div>
                <div class="focus-details">${details}</div>
            `;
        }
        
        // Funci√≥n para configurar navegaci√≥n por teclado
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (event) => {
                if (!currentFocus) return;
                
                const position = network.getViewPosition();
                const scale = network.getScale();
                const step = 100 / scale;
                
                switch (event.key) {
                    case 'ArrowLeft':
                        network.moveTo({
                            position: { x: position.x - step, y: position.y },
                            animation: { duration: 300 }
                        });
                        break;
                    case 'ArrowRight':
                        network.moveTo({
                            position: { x: position.x + step, y: position.y },
                            animation: { duration: 300 }
                        });
                        break;
                    case 'ArrowUp':
                        network.moveTo({
                            position: { x: position.x, y: position.y - step },
                            animation: { duration: 300 }
                        });
                        break;
                    case 'ArrowDown':
                        network.moveTo({
                            position: { x: position.x, y: position.y + step },
                            animation: { duration: 300 }
                        });
                        break;
                    case 'Enter':
                        if (currentFocus) {
                            network.focus(currentFocus.id, {
                                scale: 1.5,
                                animation: { duration: 800 }
                            });
                        }
                        break;
                }
            });
        }
        
        // Funci√≥n para alternar vista
        function toggleView() {
            isDirectLineView = !isDirectLineView;
            const toggle = document.getElementById('viewToggle');
            
            if (isDirectLineView) {
                toggle.textContent = 'Vista: L√≠nea Directa';
                toggle.classList.add('active');
                // Filtrar solo l√≠nea directa
                const directLineNodes = network.body.data.nodes.get().filter(node => node.isDirectLine);
                const directLineEdges = network.body.data.edges.get().filter(edge => {
                    const fromNode = network.body.data.nodes.get(edge.from);
                    const toNode = network.body.data.nodes.get(edge.to);
                    return fromNode && toNode && fromNode.isDirectLine && toNode.isDirectLine;
                });
                
                network.setData({
                    nodes: directLineNodes,
                    edges: directLineEdges
                });
            } else {
                toggle.textContent = 'Vista: Completa';
                toggle.classList.remove('active');
                // Restaurar datos originales
                const originalData = convertToVisData(window.originalTreeData || loadLocalData());
                network.setData(originalData);
            }
            
            updateStats();
        }
        
        // Funci√≥n para actualizar estad√≠sticas
        function updateStats() {
            const nodes = network.body.data.nodes.get();
            const generations = new Set();
            
            nodes.forEach(node => {
                generations.add(node.generation);
            });
            
            document.getElementById('personCount').textContent = nodes.length;
            document.getElementById('generationCount').textContent = generations.size;
        }
        
        // Funci√≥n principal para inicializar
        async function init() {
            try {
                let rows = await fetchGoogleSheet(SHEET_ID, SHEET_GID);
                
                if (!rows || rows.length === 0) {
                    rows = loadLocalData();
                }
                
                // Guardar datos originales
                window.originalTreeData = rows;
                
                const visData = convertToVisData(rows);
                createTree(visData);
                
                document.getElementById('viewToggle').addEventListener('click', toggleView);
                
            } catch (error) {
                console.error('Error inicializando √°rbol:', error);
                const rows = loadLocalData();
                window.originalTreeData = rows;
                const visData = convertToVisData(rows);
                createTree(visData);
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
        
        window.addEventListener('resize', () => {
            if (network) {
                network.fit({
                    animation: { duration: 500 }
                });
            }
        });
    </script>
</body>
</html>
