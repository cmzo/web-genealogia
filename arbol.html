<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årbol Geneal√≥gico - Matias Clemenzo</title>
    <meta http-equiv="refresh" content="0; url=arbol-nuevo.html">
    <script>window.location.replace('arbol-nuevo.html');</script>
    <link rel="stylesheet" href="./assets/css/styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
        .tree-container {
            width: 100%;
            height: 80vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .tree-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tree-node:hover {
            transform: scale(1.05);
        }
        
        .tree-node.focused {
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.15));
        }
        
        .tree-node.unfocused {
            opacity: 0.2;
            filter: grayscale(0.8) blur(1px);
        }
        
        .node-circle {
            stroke: #374151;
            stroke-width: 2;
            transition: all 0.3s ease;
        }
        
        .tree-node:hover .node-circle {
            stroke-width: 3;
        }
        
        .tree-node.focused .node-circle {
            stroke-width: 4;
            stroke: #1f2937;
        }
        
        .node-text {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            text-anchor: middle;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .tree-link {
            stroke: #9ca3af;
            stroke-width: 2;
            fill: none;
            transition: all 0.3s ease;
        }
        
        .tree-link.focused {
            stroke: #374151;
            stroke-width: 3;
        }
        
        .tree-link.unfocused {
            stroke: #d1d5db;
            stroke-width: 1;
            opacity: 0.3;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #374151;
        }
        
        .key-hint {
            margin: 4px 0;
            font-weight: 500;
        }
        
        .focus-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
            color: #374151;
            max-width: 300px;
        }
        
        .focus-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .focus-details {
            font-size: 12px;
            color: #6b7280;
        }
        
        .keyboard-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .keyboard-indicator.show {
            opacity: 1;
    }
  </style>
</head>
<body>
    <header>
        <nav>
            <a href="./index.html">‚Üê Inicio</a>
        </nav>
    </header>

    <main>
        <section class="hero">
            <div class="hero-content">
                <h1>√Årbol Geneal√≥gico</h1>
                <p>Explora tu historia familiar</p>
            </div>
        </section>

        <section class="content">
            <div class="tree-container" id="tree">
                <div class="keyboard-indicator" id="keyboardIndicator">Navegando...</div>
                <div class="controls">
                    <div class="key-hint">üñ±Ô∏è Mouse: Arrastrar para mover</div>
                    <div class="key-hint">üîç Rueda: Zoom</div>
                    <div class="key-hint">‚¨ÖÔ∏è‚û°Ô∏è Flechas: Navegar</div>
                    <div class="key-hint">‚å®Ô∏è Enter: Centrar en foco</div>
            </div>
                <div class="focus-info" id="focusInfo">
                    <div class="focus-name">Francisco Clemenzo</div>
                    <div class="focus-details">Tatarabuelo ‚Ä¢ 1856-1928</div>
        </div>
      </div>
    </section>
  </main>

    <footer style="background: #1f2937; color: white; text-align: center; padding: 20px; margin-top: 48px;">
        <div class="footer-container" style="max-width: 1200px; margin: 0 auto;">
            <p class="footer-text" style="margin: 0; font-size: 14px;">Matias Clemenzo 2025</p>
        </div>
    </footer>

    <script src="./assets/js/path-config.js"></script>
    <script src="./content/data/arbol.js"></script>
  <script>
        // Configuraci√≥n
        const SHEET_ID = '1sFJMyqqEBkDPuGaX3kXANqppTfWijo__kGjRYY8hDEI';
        const SHEET_GID = '0';
        
        // Estado del √°rbol
        let treeData = null;
        let currentFocus = null;
        let svg, g, zoom;
        
        // Funci√≥n para obtener datos de Google Sheets
        async function fetchGoogleSheet(sheetId, gid) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
            try {
                const response = await fetch(url);
                const text = await response.text();
                const jsonText = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonText);
                
                if (data.table && data.table.rows) {
                    return data.table.rows.map(row => {
          const obj = {}; 
                        data.table.cols.forEach((col, index) => {
                            if (row.c[index]) {
                                obj[col.label] = row.c[index].v;
                            }
          }); 
          return obj; 
        });
                }
                return null;
            } catch (error) {
                console.warn('[Sheet] Error:', error);
                return null;
            }
        }
        
        // Funci√≥n para convertir filas a estructura de √°rbol
        function rowsToTree(rows) {
            const nodes = {};
            
            // Crear nodos
            rows.forEach(row => {
                const id = row.id;
                const parentId = row.parent_id;
                
                nodes[id] = {
                    id: id,
                    name: row.name || 'Sin nombre',
                    birth_date: row.birth_date || '',
                    death_date: row.death_date || '',
                    birth_place: row.birth_place || '',
                    spouse_name: row.spouse_name || '',
                    spouse_birth_date: row.spouse_birth_date || '',
                    children: []
                };
            });
            
            // Establecer relaciones padre-hijo
            rows.forEach(row => {
                const id = row.id;
                const parentId = row.parent_id;
                
                if (parentId && parentId !== '' && nodes[parentId]) {
                    nodes[parentId].children.push(nodes[id]);
                }
            });
            
            // Encontrar la ra√≠z (nodo sin padre)
            let root = null;
            rows.forEach(row => {
                const id = row.id;
                const parentId = row.parent_id;
                
                if (!parentId || parentId === '') {
                    root = nodes[id];
                }
            });
            
            return root || Object.values(nodes)[0];
        }
        
        // Funci√≥n para cargar datos locales
        function loadLocalData() {
            const paternalTree = window.FAMILY_TREE || { name: 'Sin datos', children: [] };
            return paternalTree;
        }
        
        // Funci√≥n para crear el √°rbol visual
        function createTree(data) {
            const container = document.getElementById('tree');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Limpiar solo el contenido SVG, no todo el contenedor
            const existingSvg = container.querySelector('svg');
            if (existingSvg) {
                existingSvg.remove();
            }
            
            // Crear SVG
            svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Crear grupo principal
            g = svg.append('g');
            
            // Configurar zoom
            zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            // Crear solo la l√≠nea directa
            const directLineData = createDirectLineData(data);
            const root = d3.hierarchy(directLineData);
            
            // Layout simple vertical
            const treeLayout = d3.tree()
                .size([width - 200, height - 200])
                .separation(() => 1.5);
            
            treeLayout(root);
            
            // Centrar verticalmente
            const centerX = width / 2;
            root.descendants().forEach((node, index) => {
                node.x = centerX;
                node.y = 100 + index * 120;
            });
            
            // Crear enlaces (solo l√≠nea directa)
            const links = g.selectAll('.tree-link')
                .data(root.links())
                .join('path')
                .attr('class', 'tree-link')
                .attr('d', d3.linkVertical()
                    .x(d => d.x)
                    .y(d => d.y))
                .style('stroke', '#1f2937')
                .style('stroke-width', '3px')
                .style('fill', 'none');
            
            // Crear nodos
            const nodes = g.selectAll('.tree-node')
                .data(root.descendants())
                .join('g')
                .attr('class', 'tree-node')
                .attr('transform', d => `translate(${d.x},${d.y})`)
                .on('click', (event, d) => {
                    setFocus(d);
                });
            
            // Crear c√≠rculos de nodos
            nodes.append('circle')
                .attr('class', 'node-circle')
                .attr('r', 25)
                .attr('fill', d => getNodeColor(d));
            
            // Crear texto de nodos
            nodes.append('text')
                .attr('class', 'node-text')
                .attr('y', -35)
                .attr('font-size', '14px')
                .text(d => d.data.name);
            
            // Configurar navegaci√≥n por teclado
            setupKeyboardNavigation(root);
            
            // Establecer foco inicial
            setFocus(root);
        }
        
        // Funci√≥n para obtener color del nodo
        function getNodeColor(d) {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
            return colors[d.depth % colors.length];
        }
        
        // Funci√≥n para establecer foco
        function setFocus(node) {
            currentFocus = node;
            
            // Actualizar informaci√≥n de foco
            updateFocusInfo(node);
            
            // Actualizar clases de nodos
            g.selectAll('.tree-node')
                .classed('focused', d => d === node)
                .classed('unfocused', d => d !== node);
        }
        
        // Funci√≥n para verificar si un nodo est√° en la l√≠nea directa
        function isInDirectLine(node, focus) {
            if (node === focus) return true;
            
            // Definir la l√≠nea directa por nombres
            const directLineNames = [
                'Francisco Clemenzo',
                'Felix Clemenzo', 
                'Felix Ricardo Clemenzo',
                'Daniel Jorge Clemenzo',
                'Matias Damian Clemenzo'
            ];
            
            // Verificar si el nodo est√° en la l√≠nea directa
            return directLineNames.includes(node.data.name);
        }
        
        // Funci√≥n para crear datos de solo la l√≠nea directa
        function createDirectLineData(data) {
            const directLineNames = [
                'Francisco Clemenzo',
                'Felix Clemenzo', 
                'Felix Ricardo Clemenzo',
                'Daniel Jorge Clemenzo',
                'Matias Damian Clemenzo'
            ];
            
            // Buscar Francisco en los datos originales
            function findPersonByName(name, person) {
                if (person.name === name) {
                    return person;
                }
                if (person.children) {
                    for (let child of person.children) {
                        const found = findPersonByName(name, child);
                        if (found) return found;
                    }
                }
                return null;
            }
            
            // Construir la l√≠nea directa
            const directLine = [];
            for (let name of directLineNames) {
                const person = findPersonByName(name, data);
                if (person) {
                    directLine.push({
                        name: person.name,
                        birth_date: person.birth_date || '',
                        death_date: person.death_date || '',
                        spouse_name: person.spouse_name || '',
                        children: []
                    });
                }
            }
            
            // Establecer relaciones padre-hijo
            for (let i = 0; i < directLine.length - 1; i++) {
                directLine[i].children = [directLine[i + 1]];
            }
            
            return directLine[0] || { name: 'Sin datos', children: [] };
        }
        

        
        // Funci√≥n para centrar en un nodo
        function centerOnNode(node) {
            const container = document.getElementById('tree');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const transform = d3.zoomTransform(svg.node());
            const x = width / 2 - node.x;
            const y = height / 2 - node.y;
            
            // Aplicar transformaci√≥n directamente sin transici√≥n para evitar vibraci√≥n
            svg.call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(transform.k));
        }
        
        // Funci√≥n para actualizar informaci√≥n de foco
        function updateFocusInfo(node) {
            const focusInfo = document.getElementById('focusInfo');
            if (!focusInfo) {
                console.warn('Elemento focusInfo no encontrado');
                return;
            }
            
            const name = node.data.name;
            const birthDate = node.data.birth_date || '';
            const deathDate = node.data.death_date || '';
            const spouse = node.data.spouse_name || '';
            
            let details = '';
            if (birthDate) {
                details += birthDate;
                if (deathDate) details += ` - ${deathDate}`;
            }
            
            if (spouse) {
                details += details ? ` ‚Ä¢ ${spouse}` : spouse;
            }
            
            focusInfo.innerHTML = `
                <div class="focus-name">${name}</div>
                <div class="focus-details">${details}</div>
            `;
        }
        
        // Funci√≥n para mostrar indicador de teclado
        function showKeyboardIndicator(message) {
            const indicator = document.getElementById('keyboardIndicator');
            if (!indicator) {
                console.warn('Elemento keyboardIndicator no encontrado');
                return;
            }
            
            indicator.textContent = message;
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1000);
        }
        
        // Funci√≥n para configurar navegaci√≥n por teclado
        function setupKeyboardNavigation(root) {
            document.addEventListener('keydown', (event) => {
                if (!currentFocus) return;
                
                console.log('Tecla presionada:', event.key);
                
                switch (event.key) {
                    case 'ArrowUp':
                        // Subir a la generaci√≥n anterior
                        if (currentFocus.parent) {
                            showKeyboardIndicator('‚¨ÜÔ∏è ' + currentFocus.parent.data.name);
                            setFocus(currentFocus.parent);
                        }
                        break;
                    case 'ArrowDown':
                        // Bajar a la siguiente generaci√≥n
                        if (currentFocus.children && currentFocus.children.length > 0) {
                            showKeyboardIndicator('‚¨áÔ∏è ' + currentFocus.children[0].data.name);
                            setFocus(currentFocus.children[0]);
                        }
                        break;
                    case 'Enter':
                        console.log('Centrando en nodo:', currentFocus.data.name);
                        showKeyboardIndicator('üéØ Centrando en: ' + currentFocus.data.name);
                        centerOnNode(currentFocus);
                        break;
                }
            });
        }
        
        // Funci√≥n principal para inicializar
        async function init() {
            try {
                // Intentar cargar desde Google Sheets
                let rows = await fetchGoogleSheet(SHEET_ID, SHEET_GID);
                
                if (rows && rows.length > 0) {
                    treeData = rowsToTree(rows);
                } else {
                    // Fallback a datos locales
                    treeData = loadLocalData();
                }
                
                // Crear el √°rbol
                createTree(treeData);
                
            } catch (error) {
                console.error('Error inicializando √°rbol:', error);
                // Fallback a datos locales
                treeData = loadLocalData();
                createTree(treeData);
            }
        }
        
        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', init);
        
        // Manejar redimensionamiento de ventana
        window.addEventListener('resize', () => {
            if (treeData) {
                createTree(treeData);
            }
        });
  </script>
</body>
</html>


